<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> ELK-stack · f00bar</title><meta name="description" content="ELK-stack - lancezhu"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/naruto.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@10.4.1/styles/github.min.css"><link rel="search" type="application/opensearchdescription+xml" href="https://lancezhu.github.io/atom.xml" title="f00bar"><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="f00bar" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/naruto.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/LanceZhu" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Note-ELK-Stack-Elasticsearch、Logstash、Kibana"><span class="toc-number">1.</span> <span class="toc-text">[Note] ELK Stack(Elasticsearch、Logstash、Kibana)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基本要求"><span class="toc-number">1.2.</span> <span class="toc-text">基本要求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ELK-Stack"><span class="toc-number">1.3.</span> <span class="toc-text">ELK Stack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Elasticsearch"><span class="toc-number">1.3.1.</span> <span class="toc-text">Elasticsearch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Logstash"><span class="toc-number">1.3.2.</span> <span class="toc-text">Logstash</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Mysql-输入插件"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">Mysql 输入插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Elasticsearch-输出插件"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">Elasticsearch 输出插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kibana"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">kibana</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基本使用"><span class="toc-number">1.4.</span> <span class="toc-text">基本使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#启动-ELK"><span class="toc-number">1.4.1.</span> <span class="toc-text">启动 ELK</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置-ELK"><span class="toc-number">1.4.2.</span> <span class="toc-text">配置 ELK</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#logstash"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">logstash</span></a></li></ol></li></ol></li></ol></li></ol><div class="post"><article class="post-block"><h1 class="post-title">ELK-stack</h1><div class="post-info">Oct 12, 2020</div><div class="post-content"><h1 id="Note-ELK-Stack-Elasticsearch、Logstash、Kibana"><a href="#Note-ELK-Stack-Elasticsearch、Logstash、Kibana" class="headerlink" title="[Note] ELK Stack(Elasticsearch、Logstash、Kibana)"></a>[Note] ELK Stack(Elasticsearch、Logstash、Kibana)</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>ELK Stack 由 <strong>E</strong>lasticSearch、<strong>L</strong>ogstash、<strong>K</strong>ibana 组成，分别用来处理日志的检索、收集及可视化。本文的契机是为了替代原有的正则匹配字符串的检索方式，优化全文检索的效果。下面介绍 ELK 的安装及基本使用（以 MySQL 为数据源，使用 Logstash 导入至 ElasticSearch，最终通过 Kibana 验证查询效果）</p>
<h2 id="基本要求"><a href="#基本要求" class="headerlink" title="基本要求"></a>基本要求</h2><p>推荐硬件配置：内存 4G</p>
<h2 id="ELK-Stack"><a href="#ELK-Stack" class="headerlink" title="ELK Stack"></a>ELK Stack</h2><p>以下安装适用于 Ubuntu 等 Debian 系操作系统。</p>
<h3 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h3><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.9/deb.html" target="_blank" rel="noopener"><strong>download</strong></a></p>
<p><strong>配置软件源+安装依赖</strong></p>
<pre><code class="hljs bash">$ wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -
$ sudo apt-get install apt-transport-https
$ <span class="hljs-built_in">echo</span> <span class="hljs-string">"deb https://artifacts.elastic.co/packages/7.x/apt stable main"</span> | sudo tee /etc/apt/sources.list.d/elastic-7.x.list</code></pre>

<p><strong>安装 Elasticsearch</strong></p>
<pre><code class="hljs bash">$ sudo apt-get update &amp;&amp; sudo apt-get install elasticsearch
$ sudo systemctl start elasticsearch.service
$ curl -X <span class="hljs-string">'GET'</span> <span class="hljs-string">'http://localhost:9200'</span> <span class="hljs-comment"># 验证安装、启动是否成功</span></code></pre>

<h3 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h3><p><a href="https://www.elastic.co/guide/en/logstash/7.9/installing-logstash.html" target="_blank" rel="noopener"><strong>download</strong></a></p>
<pre><code class="hljs bash">$ sudo apt-get update &amp;&amp; sudo apt-get install logstash
$ <span class="hljs-built_in">cd</span> /usr/share/logstash/bin
$ sudo chmod 777 -R /usr/share/logstash/data
$ bash logstash -f mp-analyzer-debug-list.conf <span class="hljs-comment"># -f 选择配置文件</span></code></pre>

<h4 id="Mysql-输入插件"><a href="#Mysql-输入插件" class="headerlink" title="Mysql 输入插件"></a>Mysql 输入插件</h4><p>默认安装，可通过以下操作进行验证</p>
<pre><code class="hljs bash">$ <span class="hljs-built_in">cd</span> /usr/share/logstash/bin
$ bash logstash-plugin list <span class="hljs-comment"># 查看所有插件</span>
$ bash logstash-plugin list | grep logstash-input-jdbc</code></pre>

<p><strong>jdbc(Java database connector)</strong></p>
<p>用于连接 MySQL</p>
<p><a href="https://dev.mysql.com/downloads/connector/j/" target="_blank" rel="noopener"><strong>download</strong></a></p>
<h4 id="Elasticsearch-输出插件"><a href="#Elasticsearch-输出插件" class="headerlink" title="Elasticsearch 输出插件"></a>Elasticsearch 输出插件</h4><p>默认安装，可通过以下操作进行验证</p>
<pre><code class="hljs bash">$ <span class="hljs-built_in">cd</span> /usr/share/logstash/bin
$ bash logstash-plugin list <span class="hljs-comment"># 查看所有插件</span>
$ bash logstash-plugin list | grep logstash-output-elasticsearch
logstash-output-elasticsearch</code></pre>

<h4 id="kibana"><a href="#kibana" class="headerlink" title="kibana"></a>kibana</h4><p><a href="https://www.elastic.co/guide/en/kibana/7.9/deb.html" target="_blank" rel="noopener"><strong>download</strong></a></p>
<pre><code class="hljs bash">$ sudo apt-get update &amp;&amp; sudo apt-get install kibana
$ sudo systemctl start kibana
$ open http://localhost:5601 <span class="hljs-comment"># 打开浏览器查看</span></code></pre>

<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><p>MySQL 作为数据源，使用 Logstash 导入至 Elasticsearch，并通过 kibana 可视化查询，验证查询效果</p>
<h3 id="启动-ELK"><a href="#启动-ELK" class="headerlink" title="启动 ELK"></a>启动 ELK</h3><pre><code class="hljs bash"><span class="hljs-comment"># 直接启动 elasticsearch</span>
$ sudo systemctl start elasticsearch.service

<span class="hljs-comment"># 配置文件指定 MySQL、jdbc及输出格式</span>
$ <span class="hljs-built_in">cd</span> /usr/share/logstash/bin
$ bash logstash -f mp-analyzer-debug-list.conf <span class="hljs-comment"># -f 选择配置文件，mp-analyzer-debug-list.conf 内容见下文</span>

<span class="hljs-comment"># 直接启动 kibana</span>
$ sudo systemctl start kibana
$ open http://localhost:5601 <span class="hljs-comment"># 打开浏览器查看</span></code></pre>

<h3 id="配置-ELK"><a href="#配置-ELK" class="headerlink" title="配置 ELK"></a>配置 ELK</h3><h4 id="logstash"><a href="#logstash" class="headerlink" title="logstash"></a>logstash</h4><p>mp-analyzer-debug-list.conf</p>
<pre><code class="hljs markdown">input &#123;
  jdbc &#123;
<span class="hljs-code">    jdbc_driver_library =&gt; "/home/ubuntu/projects/mysql-connector-java/mysql-connector-java-8.0.21/mysql-connector-java-8.0.21.jar"</span>
<span class="hljs-code">    jdbc_driver_class =&gt; "com.mysql.jdbc.Driver"</span>
<span class="hljs-code">    jdbc_connection_string =&gt; "jdbc:mysql://your_server_ip:3306/database"</span>
<span class="hljs-code">    jdbc_user =&gt; "user"</span>
<span class="hljs-code">    jdbc_password =&gt; "password"</span>
<span class="hljs-code">    schedule =&gt; "* * * * *"</span>
<span class="hljs-code">    statement =&gt; "SELECT * FROM movies WHERE id &gt;= 0"</span>
<span class="hljs-code">    use_column_value =&gt; true</span>
<span class="hljs-code">    tracking_column_type =&gt; "numeric"</span>
<span class="hljs-code">    tracking_column =&gt; "id"</span>
<span class="hljs-code">    last_run_metadata_path =&gt; "syncpoint_table"</span>
  &#125;
&#125;

output &#123;
  elasticsearch &#123;
<span class="hljs-code">    hosts =&gt; ["127.0.0.1"]</span>
<span class="hljs-code">    index =&gt; "debug-list"</span>
<span class="hljs-code">    document_id =&gt; "%&#123;id&#125;"</span>
  &#125;
&#125;</code></pre>
</div></article></div></main><footer><div class="paginator"><a href="/2020/11/10/about-me/" class="prev">PREV</a><a href="/2020/10/12/icejs-todos-server/" class="next">NEXT</a></div><div class="copyright"><p>© 2017 - 2023 <a href="https://lancezhu.github.io">lancezhu</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script src="//cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script><script src="/js/copy-codeblock.js"></script></body></html>